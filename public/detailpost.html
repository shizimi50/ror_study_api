<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoR Study API</title>
    <link rel="stylesheet" href="style/style.css">
    <!-- Bootstrap CSS -->
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1"
    crossorigin="anonymous"
    />
    <!-- fontawesome -->
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
</head>
<body>
    <section>
        <div class="section-header">
            <h1>投稿 詳細</h1>
        </div>
        <div class="section-body">
            <div id="detail_all_btn"></div>
            <div class="d-flex bd-highlight mb-3" style="max-width: 550px; margin: 30px auto;">
                <div class="col-8 mt-2">
                    <a href="index.html"><span>戻る</span></a>
                </div>
                <div id="detail_all_btn" class="col-2">
                    <input id="editpost_btn" onclick="changeHref()" type="submit" class="btn btn-secondary text-white" value="編集">
                </div>
                <div class="col-2">
                    <input id="deletepost_btn" type="button" class="btn btn-outline-danger" value="削除">
                </div>
            </div>

            <!-- 投稿表示 -->
            <div id="detail_post" style="max-width: 600px; margin: 30px auto;"></div>


            <!-- コメント作成 -->
            <form id="createcomment_form" style="max-width: 600px; margin: 0 auto;" class="needs-validation" novalidate >
                <div class="form-group">
                    <label for="comment">コメント</label><small class="text-danger"> ※ 必須（255文字以内）</small>
                    <textarea name="comment" id="comment" class="form-control" required ></textarea>
                    <div class="err_msg mb-4 text-danger">「内容」を入力してください</div>
                </div>

                <div class="row" style="max-width: 600px; margin: 30px auto;">
                    <div class="form-group col-8 p-0">
                        <label for="post_created_by">コメント者</label>
                        <input type="text" name="comment_created_by" id="comment_created_by" class="form-control">
                    </div>
                    <div class="col-4 text-center" style="margin: 20px 0px;"> 
                        <input id="createcomment_btn" type="button" class="btn btn-secondary text-white" value="登録" onclick="formCommentCheck()">
                    </div>
                </div>
                <div>
                    <div class="col-4 form-group" style="margin-left: 400px;">
                        <select class="form-control" name="select_sort">
                            <option value="created_at DESC">作成日時（降順）</option>
                            <option value="created_at ASC">作成日時（昇順）</option>
                            <option value="comment_created_by DESC">コメント者（降順）</option>
                            <option value="comment_created_by ASC">コメント者（昇順）</option>
                        </select>
                    </div>
                </div>
            </form>

            <!-- コメント表示 -->
            <div id="specific_comments" style="max-width: 600px; margin: 30px auto;"></div>
                
        </div>
    </section>


    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- jQuery UI 1.11.4 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <!-- Bootstrap 4 -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
    "use strict";
    
        /*-------グローバル変数-------*/
        //バリデーション初期表示は非表示
        let errMsg_0 = document.querySelectorAll(".err_msg")[0]
        errMsg_0.style.display = "none";

        //クリックした掲示板のidをパラメータとして取得
        let postId = location.search.slice(4);

        //API関連変数
        let editUrl= '';
        let cotent = document.getElementById('comment');
        let comment_created_by = document.getElementById('comment_created_by');
        let detailPostUrl = `http://127.0.0.1:3001/api/v1/posts/${postId}`;
        /*--------------------------*/


        window.onload = function() {

            // API関する処理
            detailPostApi() //投稿詳細取得
            CommentApi() //投稿に紐づくコメント取得

            // 投稿ソートキーを取得
            document.querySelector("select[name=select_sort]").addEventListener('change', function() {
                CommentApi()
            })

        }


        // 掲示板詳細のデータを取得
        function detailPostApi() {

            let post = ''; //投稿詳細データ

            fetch(detailPostUrl,{ 
                method: 'GET',
            }).then(response => response.json())
            .then(data => {
                console.log('Success:', data);
                let postData = data.data.post //投稿データ取得

                // 投稿作成日時の成形
                let cd = new Date(postData.created_at)
                let created_at_format = cd.getFullYear() + '年' + (cd.getMonth() + 1) + '月' + cd.getDate() + '日 ' + cd.getHours() + '時' + cd.getMinutes() + '分';

                // 投稿更新日時の成形
                let ud = new Date(postData.updated_at)
                let updated_at_format = ud.getFullYear() + '年' + (ud.getMonth() + 1) + '月' + ud.getDate() + '日 ' + ud.getHours() + '時' + ud.getMinutes() + '分';

                //投稿データを表示
                editUrl += `editpost.html?id=${postData.id}`;

                post += `<div class="mb-5"><h4 class="bg-light p-3">${postData.title}</h4></div>`
                post += `<div class="mb-5"><h5 class="p-2">内容</h5>${postData.content}</p></div>`
                post += `<small class=""><p>作成日時：${created_at_format}</p></small>`
                post += `<small class="mb-5"><p>更新日時：${updated_at_format}</p></small>`

                document.getElementById('detail_post').innerHTML = post

            }).catch((error)=>{
                console.log(error);
            })
        };


        // 投稿削除の処理
        document.getElementById("deletepost_btn").onclick = function() {

            // 削除チェック
                var res = confirm("投稿を削除してもよろしいですか？");
                if( res == true ) {
                    // OKなら削除APIを叩く
                    fetch(detailPostUrl,{
                        method: 'DELETE',
                    }).then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                        alert("投稿を削除しました！");
                        location.href = "index.html";
                    }).catch((error)=>{
                        console.log(error);
                    })
                }
                else {
                    // キャンセルならアラートボックスを表示
                    alert("削除をキャンセルしました。");
                }
        };

        //編集ボタンへの遷移先変更処理
        function changeHref() {
            location.href = editUrl
        }


        // コメント表示の処理
        function CommentApi() {

            let comment = ''; //特定のコメントデータ
            let sortkey = document.getElementsByName('select_sort')[0].value //ソートキー取得
    
            fetch(`${detailPostUrl}/comments?sortkey=${sortkey}`,{
                    method: 'GET',
                }).then(response => response.json())
            .then(data => {
                console.log('Success:', data);

                //コメントデータを表示
                let commentsData = data.data.comments 
                commentsData.forEach(comment_e => {
                    
                    // 投稿作成日時の成形
                    let comment_e_cd = new Date(comment_e.created_at)
                    let comment_created_at_format = comment_e_cd.getFullYear() + '年' + (comment_e_cd.getMonth() + 1) + '月' + comment_e_cd.getDate() + '日 ' + comment_e_cd.getHours() + '時' + comment_e_cd.getMinutes() + '分';
                        
                        comment += '<div class="card shadow-sm mb-3">'
                        comment += '<div class="card-body pl-3 pt-3">'
    
                        comment += '<div class="row">'
                        comment += `<p class="card-text col-10 pt-2">${comment_e.comment}</p>`
                        comment += '<div id="parent_btn" class="col-2">'
                        comment += `<button id="deletecomment_btn" onclick="commentDeleteApi(${comment_e.id})" type="button" class="btn btn-sm btn-outline-danger">`
                        comment += '<font style="vertical-align: inherit;">削除</font></button>'
                        comment += '</div>'
                        comment += '</div>'
                        comment += '<div class="row">'
                        comment += `<small class="col-7 card-text">作成日時：${comment_created_at_format}</small>`
                        comment += `<small class="col-5 card-text">コメント者：${comment_e.comment_created_by}</small>`
                        comment += `</div>`
                        comment += '</div>'
                        comment += '</div>'
                });
                document.getElementById('specific_comments').innerHTML = comment

            }).catch((error)=>{
                console.error(error);
            });
        }


        // コメント新規作成の処理
        function createCommentApi() {

            let createCommentForm = document.getElementById("createcomment_form");
            let createCommentFormData = new FormData(createCommentForm);
    
            fetch(`${detailPostUrl}/comments`,{
                    method: 'POST',
                    body: createCommentFormData,
                }).then((response) => {
                
                if(!response.ok){
                    throw new Error(`${response.status} ${response.statusText}`)
                }
                alert("登録が完了しました！")
                location.reload();
    
                }).catch((error)=>{
                    console.error(error);
                });
        }


        // // コメント削除の処理
        function commentDeleteApi(commentId){
            console.log(commentId);

            // 削除チェック
            var res = confirm("コメントを削除してもよろしいですか？");
                if( res == true ) {
                    // OKなら削除APIを叩く
                    fetch(`${detailPostUrl}/comments/${commentId}`,{ 
                        method: 'DELETE',

                    }).then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                        alert("投稿を削除しました！");
                        location.reload();

                    }).catch((error)=>{
                        console.log(error);
                    })
                }
                else {
                    // キャンセルならアラートボックスを表示
                    alert("削除をキャンセルしました。");
                }
        };


        // コメントフォームチェック処理
        function formCommentCheck() {

            // 「お名前」入力欄の空欄チェック
            // フォームの要素を取得
            errMsg_0.style.display = "none"
            let comment = errMsg_0.previousElementSibling
            comment.removeAttribute('style');
                            
            if (comment.value == '') {
                errMsg_0.style.display = "block"
                errMsg_0.previousElementSibling.style.border = '1px solid #f50000'
                return;
            } else if(comment.value.length > 255){
                errMsg_0.innerHTML = "「コメント」の文字数は225文字以内で入力してください"
                errMsg_0.style.display = "block"
                errMsg_0.previousElementSibling.style.border = '1px solid #f50000'
            } else {
                errMsg_0.style.display = "none"

                createCommentApi()
            }

        }



    </script>
</body>

</html>
